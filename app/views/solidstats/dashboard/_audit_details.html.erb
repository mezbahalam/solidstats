<div id="audit-details" class="details-panel hidden">
  <div class="audit-summary">
    <div class="audit-summary-header">
      <h3>Security Audit Summary</h3>
      <% created_at = @audit_output.dig("created_at") %>
      <span class="audit-date">Last updated: <%= created_at ? DateTime.parse(created_at).strftime("%B %d, %Y at %H:%M") : Time.now.strftime("%B %d, %Y at %H:%M") %></span>
    </div>
    <div class="audit-stats">
      <div class="audit-stat">
        <% results = @audit_output.dig("results") || [] %>
        <% cve_count = results.map { |r| r.dig("advisory", "cve") }.compact.uniq.size %>
        <span class="stat-value"><%= cve_count %></span>
        <span class="stat-label">CVEs</span>
      </div>
      <div class="audit-stat">
        <% gem_count = results.map { |r| r.dig("gem", "name") }.uniq.size %>
        <span class="stat-value"><%= gem_count %></span>
        <span class="stat-label">Affected Gems</span>
      </div>
      <div class="audit-stat">
        <% high_severity = results.count { |r| %w[High Critical].include?(r.dig("advisory", "criticality")) } %>
        <span class="stat-value"><%= high_severity %></span>
        <span class="stat-label">High Severity</span>
      </div>
    </div>
  </div>
  
  <% results = @audit_output.dig("results") || [] %>
  <% if results.empty? %>
    <div class="no-vulnerabilities">
      <p>âœ… No vulnerabilities found in your dependencies.</p>
    </div>
  <% else %>
    <div class="audit-filters">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="high">High Severity</button>
      <button class="filter-btn" data-filter="copy-solutions">Copy All Solutions</button>
    </div>

    <!-- Table of vulnerabilities first -->
    <div class="vulnerabilities-table">
      <table class="table">
        <thead>
          <tr>
            <th>Gem</th>
            <th>Version</th>
            <th>Criticality</th>
            <th>CVE</th>
            <th>Title</th>
            <th>Solution</th>
          </tr>
        </thead>
        <tbody>
          <% results.each_with_index do |result, index| %>
            <% 
              gem = result.dig("gem") || {}
              advisory = result.dig("advisory") || {}
              criticality = advisory["criticality"] || "Unknown"
              is_high = %w[High Critical].include?(criticality)
            %>
            <tr class="vulnerability-row <%= is_high ? 'high-severity' : '' %>" data-index="<%= index %>">
              <td><%= gem["name"] %></td>
              <td><span class="version"><%= gem["version"] %></span></td>
              <td>
                <span class="severity <%= criticality.to_s.downcase %>">
                  <%= criticality %>
                </span>
              </td>
              <td>
                <% if advisory["cve"].present? %>
                  <a href="https://nvd.nist.gov/vuln/detail/CVE-<%= advisory["cve"] %>" target="_blank">
                    CVE-<%= advisory["cve"] %>
                  </a>
                <% elsif advisory["ghsa"].present? %>
                  <a href="https://github.com/advisories/<%= advisory["ghsa"] %>" target="_blank">
                    GHSA-<%= advisory["ghsa"] %>
                  </a>
                <% else %>
                  N/A
                <% end %>
              </td>
              <td>
                <%= advisory["title"] %>
                <% if advisory["description"].present? %>
                  <a href="#vulnerability-<%= index %>" class="view-details-link">View details</a>
                <% end %>
              </td>
              <td>
                <div class="solution">
                  <% if advisory["patched_versions"].present? %>
                    <button class="copy-btn" data-solution="<%= "#{gem["name"]}, #{advisory["patched_versions"].join(", ")}" %>">
                      <span class="copy-icon">ðŸ“‹</span> Copy
                    </button>
                    <code><%= advisory["patched_versions"].join(", ") %></code>
                  <% else %>
                    <span class="no-patch">No patch available</span>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <!-- All vulnerability details at the end -->
    <div class="vulnerabilities-details-section">
      <h3>Vulnerability Details</h3>
      <% results.each_with_index do |result, index| %>
        <% 
          gem = result.dig("gem") || {}
          advisory = result.dig("advisory") || {}
          criticality = advisory["criticality"] || "Unknown"
          is_high = %w[High Critical].include?(criticality)
        %>
        <% if advisory["description"].present? %>
          <div id="vulnerability-<%= index %>" class="vulnerability-detail <%= is_high ? 'high-severity' : '' %>">
            <h4 class="vulnerability-title">
              <%= gem["name"] %> <%= gem["version"] %> - <%= advisory["title"] %>
            </h4>
            <div class="vulnerability-meta">
              <span class="severity <%= criticality.to_s.downcase %>"><%= criticality %></span>
              <% if advisory["cve"].present? %>
                <span class="cve">CVE: <%= advisory["cve"] %></span>
              <% end %>
              <% if advisory["date"].present? %>
                <span class="date">Published: <%= advisory["date"] %></span>
              <% end %>
            </div>
            <div class="description">
              <%= simple_format(advisory["description"]) %>
            </div>
            <% if advisory["url"].present? %>
              <div class="advisory-link">
                <a href="<%= advisory["url"] %>" target="_blank" rel="noopener">More information</a>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>

<style>
  /* Audit details specific styles */
  .audit-summary {
    margin-bottom: 2rem;
  }
  
  .audit-summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
  }
  
  .audit-summary-header h3 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600;
  }
  
  .audit-stats {
    display: flex;
    gap: 2rem;
    margin-bottom: 1rem;
  }
  
  .audit-stat {
    text-align: center;
  }
  
  .audit-stat .stat-value {
    display: block;
    font-size: 1.8rem;
    font-weight: 700;
    color: #333;
  }
  
  .audit-stat .stat-label {
    font-size: 0.9rem;
    color: #666;
  }
  
  .audit-filters {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  
  .filter-btn {
    background: #f1f1f1;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    font-size: 0.85rem;
    cursor: pointer;
  }
  
  .filter-btn.active {
    background: #007bff;
    color: white;
  }
  
  .vulnerability-row.high-severity {
    background-color: #fff8f8;
  }
  
  .solution {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .copy-btn {
    background: #e9ecef;
    border: none;
    border-radius: 4px;
    padding: 0.3rem 0.5rem;
    font-size: 0.8rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .copy-btn:hover {
    background: #dee2e6;
  }
  
  .copy-btn.copied {
    background: #d4edda;
    color: #155724;
  }
  
  .no-vulnerabilities {
    text-align: center;
    padding: 2rem;
    color: #155724;
  }
  
  /* Styling for details section */
  .vulnerabilities-details-section {
    margin-top: 3rem;
    border-top: 1px solid #dee2e6;
    padding-top: 1.5rem;
  }
  
  .vulnerabilities-details-section h3 {
    margin-bottom: 1.5rem;
    font-size: 1.2rem;
    font-weight: 600;
  }
  
  .vulnerability-detail {
    margin-bottom: 2rem;
    padding: 1.5rem;
    border-radius: 8px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
  }
  
  .vulnerability-detail.high-severity {
    border-left: 4px solid #dc3545;
  }
  
  .vulnerability-title {
    margin-top: 0;
    margin-bottom: 0.75rem;
    font-size: 1.1rem;
    font-weight: 600;
  }
  
  .vulnerability-meta {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    font-size: 0.85rem;
  }
  
  .cve, .date {
    color: #666;
  }
  
  .description {
    font-size: 0.9rem;
    line-height: 1.5;
    white-space: pre-line;
  }
  
  .advisory-link {
    margin-top: 1rem;
  }
  
  .advisory-link a {
    color: #007bff;
    text-decoration: none;
  }
  
  .advisory-link a:hover {
    text-decoration: underline;
  }
  
  .view-details-link {
    margin-left: 0.5rem;
    font-size: 0.85rem;
    color: #007bff;
    text-decoration: none;
  }
  
  .view-details-link:hover {
    text-decoration: underline;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Copy functionality for solution buttons
    document.querySelectorAll('.copy-btn').forEach(function(button) {
      button.addEventListener('click', function() {
        const solution = this.getAttribute('data-solution');
        navigator.clipboard.writeText(solution).then(() => {
          // Change button appearance temporarily
          const originalText = this.innerHTML;
          this.innerHTML = '<span class="copy-icon">âœ“</span> Copied!';
          this.classList.add('copied');
          
          setTimeout(() => {
            this.innerHTML = originalText;
            this.classList.remove('copied');
          }, 2000);
        });
      });
    });
    
    // View details link functionality
    document.querySelectorAll('.view-details-link').forEach(function(link) {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const target = this.getAttribute('href');
        document.querySelector(target).scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      });
    });
    
    // Filter functionality
    document.querySelectorAll('.filter-btn').forEach(function(button) {
      button.addEventListener('click', function() {
        const filter = this.getAttribute('data-filter');
        
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        
        // Handle special case for copy-solutions
        if (filter === 'copy-solutions') {
          const solutions = [];
          document.querySelectorAll('.vulnerability-row').forEach(function(row) {
            const gem = row.cells[0].textContent.trim();
            const solution = row.querySelector('.solution code')?.textContent.trim() || "No patch available";
            solutions.push(`${gem}: ${solution}`);
          });
          
          // Copy all solutions to clipboard
          navigator.clipboard.writeText(solutions.join('\n')).then(() => {
            alert('All solutions copied to clipboard!');
          });
          
          // Reset to showing all
          document.querySelectorAll('.vulnerability-row').forEach(row => {
            row.style.display = '';
          });
          
          // Show all details too
          document.querySelectorAll('.vulnerability-detail').forEach(detail => {
            detail.style.display = '';
          });
          
          return;
        }
        
        // Filter the vulnerability rows
        document.querySelectorAll('.vulnerability-row').forEach(function(row) {
          const isHigh = row.classList.contains('high-severity');
          const rowIndex = row.getAttribute('data-index');
          
          if (filter === 'all') {
            row.style.display = '';
          } else if (filter === 'high') {
            row.style.display = isHigh ? '' : 'none';
          }
          
          // Also filter the corresponding details
          const detailElement = document.getElementById(`vulnerability-${rowIndex}`);
          if (detailElement) {
            if (filter === 'all') {
              detailElement.style.display = '';
            } else if (filter === 'high') {
              detailElement.style.display = isHigh ? '' : 'none';
            }
          }
        });
      });
    });
  });
</script>
