<% # results should be passed as a local variable %>
<div class="vulnerabilities-details-section">
  <h3>
    <span>Vulnerability Details</span>
    <%# <button class="toggle-details-btn" aria-expanded="false">Show Details</button> %>
  </h3>
  <%# TODO: Render Markdown in .erb using Redcarpet with sanitize for safe HTML output %>
  <div class="md-container">
    <% results.each_with_index do |result, index| %>
      <% 
        gem = result.dig("gem") || {}
        advisory = result.dig("advisory") || {}
        criticality = advisory["criticality"] || "Unknown"
        is_high = %w[high critical].include?(criticality.to_s.downcase)
      %>
      <% if advisory["description"].present? %>
        <div id="vulnerability-<%= index %>" class="md-entry <%= is_high ? 'high-severity' : '' %>">
          <h2 class="md-heading">
            <%= gem["name"] %> <%= gem["version"] %> - <%= advisory["title"] %>
          </h2>
          
          <div class="md-metadata">
            <% if advisory["cve"].present? %>
              <div class="md-tag cve">CVE-<%= advisory["cve"] %></div>
            <% elsif advisory["ghsa"].present? %>
              <div class="md-tag ghsa">GHSA-<%= advisory["ghsa"] %></div>
            <% end %>
            <div class="md-tag severity <%= criticality.to_s.downcase %>"><%= criticality %></div>
            <% if advisory["date"].present? %>
              <div class="md-date"><%= advisory["date"] %></div>
            <% end %>
          </div>
          
          <div class="md-divider"></div>
          
          <div class="md-content">
            <%= simple_format(advisory["description"]) %>
          </div>
          
          <% if advisory["patched_versions"].present? %>
            <div class="md-code-block">
              <div class="md-code-header">Patched Versions</div>
              <pre class="md-code"><%= advisory["patched_versions"].join(", ") %></pre>
            </div>
          <% end %>
          
          <% if advisory["url"].present? %>
            <div class="md-link">
              <span class="md-link-icon">ðŸ”—</span>
              <a href="<%= advisory["url"] %>" target="_blank" rel="noopener">More information</a>
            </div>
          <% end %>
          
          <div class="md-back">
            <a href="#" class="back-to-top" onclick="window.scrollTo({top: document.querySelector('.vulnerabilities-table').offsetTop - 20, behavior: 'smooth'}); return false;">
              â†‘ Back to vulnerabilities table
            </a>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>